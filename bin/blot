#! /usr/bin/env node

'use strict'

var blot = require('../../lib/blot')
var colors = require('colors')
var program = require('commander')

var config = {
  echo: false,
  logging: false,
  pretty: false,
}

function info(action, msg) {
  if (config.pretty) {
    console.log('[' + 'blot'.bold.green + '.' + action.magenta + ']', msg)
  } else if (config.logging) {
    console.log('[blot.' + action + ']', msg)
  }
}

function error(msg) {
  if (config.pretty) {
    console.log('[' + 'blot:ERROR'.red + ']', msg)
  } else if (config.logging) {
    console.log('[blot:ERROR]', msg)
  }
}

function section(msg) {
  if (config.pretty) {
    console.log('\n--------------------------------------------------\n'.rainbow)
    console.log(msg.cyan)
    console.log('\n--------------------------------------------------\n'.rainbow)
  } else if (config.logging || config.echo) {
    console.log(msg)
  }
}

program
  .version('0.0.1')
  .command('compile')
  .description('process documentation and compile it into a static format')
  .option('-i, --in-files [files]', 'Source files (*.blot or *.apib)', 'files')
  .option('-d, --in-data [markdown]', 'Read in Markdown (UTF-8)', 'markdown')
  .option('-o, --out-file [file]', 'Write result to file(s) (*.apib , *.html or *.json)', 'file')
  .option('-e, --echo', 'Prints compiled result to stdout')
  .option('-l, --logging', 'Enables logging of blot events')
  .option('-p, --pretty', 'Formats results into visually pleasing output')
  .action(function(cmd) {
    var inFiles  = cmd.inFiles
    var inData   = cmd.inData
    var outFile  = cmd.outFile
    var echo     = config.echo    = !!cmd.echo
    var logging  = config.logging = !!cmd.logging
    var pretty   = config.pretty  = !!cmd.pretty

    ;(function() {
      if (inFiles && inFiles !== 'files') {
        info('load', 'loading and compiling files... ' + inFiles + '\n')

        return blot.io.glob(inFiles)
          .then(function(blueprints) {
            blueprints.forEach(function(blueprint,i) {
              section(blueprint.compiled.markdown)

              // FIXME - support outFile as an array
              if (!!outFile && outFile !== 'file') {
                var indexedOutFile = outFile + '.' + i + '.apib'

                blot.Blueprint
                  .dist(blueprint.compiled.markdown, indexedOutFile)
                  .then(function(content) {
                    info('dist', 'exported compiled API blueprint to ' + indexedOutFile)
                  })
                  .catch(function(err) {
                    error('failed to export ' + indexedOutFile + ': ' + err)
                  })
              }
            })
          })
          .catch(error)
      } else if (inData) {
        info('load', 'compiling API blueprint markdown...')
        
        return blot.io.read(inData)
          .then(function(blueprint) {
            section(blueprint.compiled.markdown)
          })
          .catch(error)
      } else {
        error('malformed command')
      }
    })().then()
  })

program.parse(process.argv)
